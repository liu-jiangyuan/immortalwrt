#!/bin/sh
# 02_network for BT R320 (ImmortalWrt)
# 自动配置 LAN/WAN 接口和 MAC

. /lib/functions.sh
. /lib/functions/uci-defaults.sh
. /lib/functions/system.sh

mediatek_setup_interfaces() {
    local board="$1"

    case $board in
        bt,r320)
            echo "[02_network] Setting interfaces for bt,r320"
            ucidef_set_interfaces_lan_wan "lan1 lan2 lan3" "wan"
            ucidef_add_switch "switch0" "1:lan" "2:lan" "3:lan" "4:wan" "6@eth0"
            ;;
        # 其他板子可按需添加
        *)
            echo "[02_network] Default interfaces for $board"
            ucidef_set_interfaces_lan_wan "lan1 lan2 lan3 lan4" wan
            ;;
    esac
}

mediatek_setup_macs() {
    local board="$1"
    local lan_mac=""
    local wan_mac=""
    local label_mac=""

    case $board in
        bt,r320)
            echo "[02_network] Setting MACs for bt,r320"
            # LAN MAC 从 gmac0
            lan_mac=$(mtd_get_mac_binary factory 0x2a)
            # WAN MAC 从 switch port@4
            wan_mac=$(mtd_get_mac_binary factory 0x24)
            label_mac=$wan_mac

            [ -n "$lan_mac" ] || echo "[02_network] Warning: LAN MAC empty"
            [ -n "$wan_mac" ] || echo "[02_network] Warning: WAN MAC empty"

            [ -n "$lan_mac" ] && ucidef_set_interface_macaddr "lan" "$lan_mac"
            [ -n "$wan_mac" ] && ucidef_set_interface_macaddr "wan" "$wan_mac"
            [ -n "$label_mac" ] && ucidef_set_label_macaddr "$label_mac"
            ;;
        # 可在这里添加其他板子 MAC 配置
        *)
            echo "[02_network] Default MAC setup for $board"
            ;;
    esac
}

# ---- 脚本入口 ----
echo "[02_network] Starting network setup"

board_config_update
board=$(board_name)
echo "[02_network] Detected board: $board"

mediatek_setup_interfaces "$board"
mediatek_setup_macs "$board"

board_config_flush
echo "[02_network] Network setup finished"

exit 0
